<script>
(function(){
  const USERS = [
    {id:'mehmet', name:'Mehmet'},
    {id:'batu', name:'Batu'},
    {id:'abdü', name:'Abdü'},
    {id:'kemal', name:'Kemal'}
  ];

  const dateInput = document.getElementById('datePicker');
  const todayISO = ()=> new Date().toISOString().slice(0,10);
  dateInput.value = todayISO();

  let DATA = null;

  // Backend’den veriyi çek
  async function load(){
    try{
      const res = await fetch('/api/data');
      DATA = await res.json();
      if(!DATA.users) DATA = initEmpty();
    }catch(e){DATA = initEmpty();}
    render();
  }

  function initEmpty(){
    const obj = {users:{}};
    for(const u of USERS) obj.users[u.id] = {name:u.name,total:0,byDate:{}};
    return obj;
  }

  // Backend’e güncelleme gönder
  async function save(){
    await fetch('/api/update', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(DATA)
    });
  }

  async function increment(userId){
    const day = dateInput.value || todayISO();
    const user = DATA.users[userId];
    user.byDate[day] = (user.byDate[day]||0) + 1;
    user.total = Object.values(user.byDate).reduce((a,b)=>a+b,0);
    await save();
    render();
  }

  async function resetAll(){
    if(!confirm('Tüm istatistikleri sıfırlamak istediğine emin misin?')) return;
    DATA = initEmpty();
    await save();
    render();
  }

  function render(){
    renderCards(); renderLeaderboard(); renderDayBoard(); renderLogs();
  }

  function renderCards(){
    const wrap=document.getElementById('cards'); wrap.innerHTML='';
    for(const u of USERS){
      const user=DATA.users[u.id];
      const card=document.createElement('div');card.className='card';
      card.innerHTML=`
        <div class="user-name">${user.name}</div>
        <div class="count">${user.total}</div>
        <div class="small">Toplam rezillik</div>
        <div class="user-actions">
          <button class="big-btn rezil" data-id="${u.id}">REZİL!</button>
          <button class="big-btn view" data-id="${u.id}">Ayrıntılar</button>
        </div>`;
      wrap.appendChild(card);
    }
    wrap.querySelectorAll('.big-btn.rezil').forEach(btn=>btn.addEventListener('click',e=>increment(e.currentTarget.dataset.id)));
    wrap.querySelectorAll('.big-btn.view').forEach(btn=>btn.addEventListener('click', e=>{
      const id=e.currentTarget.dataset.id;const el=document.getElementById('user-'+id);
      if(el){el.open=!el.open;el.scrollIntoView({behavior:'smooth',block:'center'});}
    }));
  }

  function renderLeaderboard(){
    const lb=document.getElementById('leaderboard'); lb.innerHTML='';
    const arr=Object.entries(DATA.users).map(([id,u])=>({id,name:u.name,total:u.total}));
    arr.sort((a,b)=>b.total-a.total);
    for(const r of arr){
      const row=document.createElement('div'); row.className='leader-row';
      row.innerHTML=`<div>${r.name}</div><div style="font-weight:800">${r.total}</div>`; lb.appendChild(row);
    }
  }

  function renderDayBoard(){
    const selDay=dateInput.value||todayISO();
    const el=document.getElementById('dayBoard'); el.innerHTML='';
    const arr=Object.entries(DATA.users).map(([id,u])=>({id,name:u.name,dayCount:(u.byDate[selDay]||0)}));
    arr.sort((a,b)=>b.dayCount-a.dayCount);
    for(const r of arr){
      const row=document.createElement('div'); row.className='leader-row';
      row.innerHTML=`<div>${r.name}</div><div style="font-weight:800">${r.dayCount}</div>`; el.appendChild(row);
    }
  }

  function renderLogs(){
    const wrap=document.getElementById('logs'); wrap.innerHTML='';
    for(const u of USERS){
      const user=DATA.users[u.id];
      const det=document.createElement('details'); det.id='user-'+u.id; det.style.marginBottom='10px';
      const summary=document.createElement('summary'); summary.innerHTML=`<strong>${user.name}</strong> — Toplam: ${user.total}`; det.appendChild(summary);
      const tbl=document.createElement('table'); const thead=document.createElement('thead'); thead.innerHTML='<tr><th>Tarih</th><th>Adet</th></tr>'; tbl.appendChild(thead);
      const tbody=document.createElement('tbody');
      const dates=Object.entries(user.byDate).sort((a,b)=>b[0].localeCompare(a[0]));
      if(dates.length===0){const tr=document.createElement('tr');tr.innerHTML='<td colspan="2" class="small-muted">Kayıt yok</td>';tbody.appendChild(tr);}else{
        for(const [date,count] of dates){const tr=document.createElement('tr');tr.innerHTML=`<td>${date}</td><td style="font-weight:800">${count}</td>`;tbody.appendChild(tr);}
      }
      tbl.appendChild(tbody);
      const foot=document.createElement('div'); foot.style.marginTop='8px'; foot.style.display='flex'; foot.style.gap='8px';
      const addBtn=document.createElement('button'); addBtn.className='btn'; addBtn.textContent='Bugüne +1'; addBtn.addEventListener('click',()=>{dateInput.value=todayISO();increment(u.id); det.open=true;});
      const removeDayBtn=document.createElement('button'); removeDayBtn.className='btn ghost'; removeDayBtn.textContent='Bu Kullanıcıyı Sıfırla'; removeDayBtn.addEventListener('click',()=>{if(!confirm(`${user.name} tüm kayıtlarını silmek istediğine emin misin?`)) return; DATA.users[u.id].byDate={}; DATA.users[u.id].total=0; save(); render();});
      foot.appendChild(addBtn); foot.appendChild(removeDayBtn);
      det.appendChild(tbl); det.appendChild(foot);
      wrap.appendChild(det);
    }
  }

  document.getElementById('resetBtn').addEventListener('click', resetAll);
  document.getElementById('exportBtn').addEventListener('click', ()=>{const blob=new Blob([JSON.stringify(DATA,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='rezil-sayaci-'+todayISO()+'.json'; a.click(); URL.revokeObjectURL(url);});
  dateInput.addEventListener('change', render);

  load();
})();
</script>
